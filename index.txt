var homeHeader;
var homeFooter;
var homeForm;
var idResults;

const MARKET_SEARCH_URL = "http://search.ams.usda.gov/farmersmarkets/v1/data.svc/";

function getDataFromUSDAApi(searchTerm) {
  const zipUrl = MARKET_SEARCH_URL + "zipSearch?zip=" + searchTerm;
  console.log(`the url is: ${zipUrl}`);
  $.ajax ({
    type : "GET",
    contentType : "application/json; charset=utf-8",
    url : zipUrl,
    dataType : 'jsonp',
    jsonpCallback : 'displayUSDASearchData'
  });
}

function getDetailsFromUSDAApi(id) {
  const detailUrl = MARKET_SEARCH_URL + "mktDetail?id=" + id;
  console.log(`the url is: ${detailUrl}`);
    $.ajax({
        type : "GET",
        contentType : "application/json; charset=utf-8",
        // submit a get request to the restful service mktDetail.
        url : detailUrl,
        dataType : 'jsonp',
        jsonpCallback : 'detailResultHandler'
    });
}

//iterate through the JSON result object.
function detailResultHandler(detailresults) {
  console.log("entering displayUSDADetailData");
    for (var key in detailresults) {
        console.log(`the key is: ${key}`);
        idResults = detailresults[key];
        console.log(`the address is: ${detailresults.Address}`);
    }
}

function renderResult(result) {
  console.log("entering renderResult");
  var marketName = result.marketname.split(" ");
  var distance = marketName.shift();
  var name = marketName.join(" ");
  //getDetailsFromUSDAApi(result.id);

  console.log(name);
  console.log(distance);
  return `
    <a class="js-image" target="_blank" href="./market.html">${name}</a>
    <span>(${distance} miles from zipcode center)</span><br>
  `;
}


function displayUSDASearchData(searchResults) {
  console.log("entering displayUSDASearchData");
  const resultsHTML = [];
  resultsHTML.push(`
    <div role="header" class="header">
        <h1>Select a Location For More Information</h1></div>
    <div class="row">
        <div class="column side" style="background-color:#aaa;"></div>
        <div class="column middle" style="background-color:#bbb;text-align:center">`);
  for (var key in searchResults) {
    console.log(`the key is: ${key}`);
    var results = searchResults[key];
    for (var i = 0; i < results.length; i++) {
      console.log(`result ${i} is : ${results[i].marketName}`);
      resultsHTML.push(renderResult(results[i]));
    }
    resultsHTML.push(`
        </div>
        <div class="column side" style="background-color:#ccc;"></div>
    </div>
    <div class="footer">
       <p>Footer</p>
    </div>`);
  const allItems = resultsHTML.join("\n");
  $('.js-main').prop('hidden',false).html(allItems);
  }
}

function getCityState(csString) {
  var divider = ",";
  var cityState = [];
  var found1 = csString.search(",");
  var found2 = csString.search(" ");
  if ( found1 >= 0 || found2 >= 0 ) {
    if (csString.search(",") < 0) {
      divider = " ";
    }
    cityState = csString.split(divider);
  }
  return cityState;
}

function backToMain(){

    // add back in the home page elements.
    // Should not have to add the callback again.
    $(homeHeader).appendTo('main');
    $(homeForm).appendTo('main');
    $(homeFooter).appendTo('main');
    $(".js-main").addClass('js-background');
}

function marketSubmit() {
  $('#market-search').submit(event => {
    event.preventDefault();

    // get the search data from the zipcode field
    const zip = $('#zipcode').val();

    // get the search data from the city-state field
    const cityState = getCityState($('#city-state').val());

    // if the data is valid, send it on to the api
    console.log(`zip length is: ${zip.length}`);
    if (zip.length > 4 && zip.length < 11) {

      // Save off the form and image for later.
      homeHeader = $('.js-main-header').detach();
      homeForm = $('.js-main-form').detach();
      homeFooter = $('.js-main-footer').detach();
      $('.js-main').removeClass("js-background");

      // Get the data from the USDA API and call the callback to display it.
      getDataFromUSDAApi(zip);
    } else if (cityState.length === 2) {
      getDataFromUSDAApi(cityState);
    } else {
      displayError();
    }
  });
}


$(marketSubmit);
